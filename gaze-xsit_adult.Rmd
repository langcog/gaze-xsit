---
title: "gaze-xsit_adult"
author: "Allison Dods"
date: "February 2, 2016"
output: html_document
---


```{r setup} 
rm(list = ls())
library(dplyr)
library(readr)
library(magrittr)
library(ggplot2)
library(tidyr)
library(knitr)
library(langcog)
library(lme4)
```

Load data and filter out unusable participants.

```{r create mastersheet}
## output: d (mastersheet with times, trial, subject, condition, and gazes)
## input: processed data spreadsheet, subject info spreadsheet, trial info

#read in processed data
d <- read_csv("processed_data_adult/processed_adult.csv")

# join subject info
subinfo <- read_csv("info/subinfo_adult.csv")

d %<>% 
  mutate(subid = gsub(".txt", "", subid)) %>%
  left_join(subinfo)
  
# join trial info
trialinfo <- read_csv("info/trialinfo.csv")
d %<>% left_join(trialinfo, by = "stimulus")

# filter out unusable participants 
d %<>% filter(keep == "y")
```

Some table or way of keeping track of how many participants were removed and for what reason. 

We remove participants XX who: a) 

### Descriptives 

Goal: get a table with the following information 

* Number of participants in each condition 
* How long conditions took 

```{r}
d %>% 
    select(subid, condition) %>% 
    unique() %>% 
    group_by(condition) %>% 
    summarise(n()) %>% 
    kable()

d_descrip <- d %>% 
    group_by(subid) %>%
    select(subid, shortname, trial.type) %>% 
    unique() %>% 
    group_by(subid, trial.type) %>% 
    summarise(count = n()) 

d_descrip %>% kable()
```

### Data cleaning/munging

Here we label Areas of Interest (participant_looking_char) to be Left Picture, Right Picture, and the Center Face. We also add trial number variable.

KM question: where did these AOI numbers come from? 

```{r participant_looking_char setup}
d %<>% mutate(participant_looking_factor = factor(ifelse(x > 210 & x < 750 & y < 540, "left", 
                           ifelse(x > 1170 & x < 1710 & y < 540, "right", 
                                  ifelse(x < 1230 & x > 690 & y > 540, "face", "away")))),
              participant_looking_char = as.character(participant_looking_factor))

# add trial numbers
trial_num <- c(c("fam", "fam", "fam", "fam"), seq(1,16))
d %<>% 
    select(subid, shortname) %>% 
    unique() %>% 
    group_by(subid) %>% 
    cbind(trial_num) %>% 
    left_join(., d, by = c("subid", "shortname"))
```

Add correct column for exposure and test trials. A time slice is correct if the participant looked 
at the object that was kept from exposure to test.

We also add a column encoding whether the participant looked at the gaze target during exposure trials. 
This is only relevant for the gaze condition. In the no-gaze condition, each time slice will be False.

```{r}
d %<>% 
    mutate(correct = ifelse(target_object == participant_looking_char, TRUE, FALSE),
           gaze_follow = ifelse(look == participant_looking_char, TRUE, FALSE))
```

## Munging to get performance on exposure trials 

Next we create a data frame with just exposure trials for visualization and analysis.

First, we need to get a crosstabs of where particpants were looking during each trial. The 
target_object variable encodes the object that will appear again during test. It does not 
have to be the target of gaze. 

Note the use of the complete() function from the tidyr package for completing missing combinations of data. It turns implicitly missing values into explicitly missing values.

```{r}
# create exposure trial data frame
all.exp <- d %>% 
    filter(trial.type == "exposure" & participant_looking_char %in% c("left", "right")) %>%
    group_by(subid, trial_num, condition, participant_looking_char) %>% 
    summarise(count = n()) %>% 
    ungroup() %>% 
    complete(subid, trial_num, participant_looking_char, 
             fill = list(count = 0)) %>%
    arrange(subid) %>% 
    select(-condition) 

# add condition and where gaze was directed 
all.exp <- d %>% 
  filter(trial.type == "exposure" & participant_looking_char != "face") %>%
  select(subid, condition, trial_num, look) %>%
  unique() %>%
  left_join(all.exp, by = c("subid", "trial_num"))
```

Add proportion correct looking (looking at the object that will show up again at test) and
proportion gaze following which is looking at the target of gaze for participants in the gaze
condition.

TODO: Sanity check: 
* Proportion of looks to objects in No Gaze exposure trials should be 50-50 across all trials.
* Proprotion gaze following in the gaze condition: we predict > 80% looking to the target of gaze

```{r exposure ng}
tmp <- all.exp %>% 
    group_by(condition, participant_looking_char, subid, look) %>% 
    summarise(looking = sum(Freq)) 
```

```{r}
#create table for looks to target by trial name (exposure only)
exp.looks.to.target <- all.exp%>%
  select(shortname, condition) %>%
  unique()

#nogaze: proportion of looking to the left over both objects for each trial
ng.exp <- all.exp %>%
  filter(condition == "nogaze")

subs <- unique(ng.exp$subid)
trials <- unique(ng.exp$shortname)
total.looks <- 0
counted.trials <- 0
for (trial in trials){
  trialtotal <- 0
  counted.subs <- 0
  for (sub in subs){
    temp <- subset(ng.exp, shortname == trial & subid == sub)
    left.to.total <- temp[[which(temp$target_object == "left" &
                                  temp$participant_looking_char == "left"), "Freq"]] +
      temp[[which(temp$target_object == "left" & temp$participant_looking_char == "right"), "Freq"]]
    right.to.total <- temp[[which(temp$target_object == "right" &
                                   temp$participant_looking_char == "left"), "Freq"]] +
      temp[[which(temp$target_object == "right" & temp$participant_looking_char == "right"), "Freq"]]
    if(left.to.total + right.to.total != 0){
      if(left.to.total == 0){
        correct_TO = "right"
        incorrect_TO = "left"
      } else{
        correct_TO = "left"
        incorrect_TO = "right"
      }
      temp <- subset(temp, target_object == correct_TO)
      corr <- temp[[which(temp$participant_looking_char == correct_TO), "Freq"]]
      incorr <- temp[[which(temp$participant_looking_char == incorrect_TO), "Freq"]]
      target <- corr / (corr+incorr)
      all.exp$exptarget[all.exp$subid == sub & all.exp$shortname == trial & 
                     all.exp$target_object == correct_TO] <- target
      total.looks <- total.looks + target
      counted.trials = counted.trials + 1
      counted.subs = counted.subs + 1
      trialtotal <- trialtotal + target
    }
  }
  trialmean <- trialtotal / counted.subs
  exp.looks.to.target$targetprop[exp.looks.to.target$shortname == trial &
                                   exp.looks.to.target$condition == "nogaze"] <-trialmean
}

#proportion of looks to left object across No Gaze exposure trials
nsmean <- total.looks / counted.trials
```

```{r exposure g}
#gaze: proportion of looking to object of gaze for each trial

g.exp <- all.exp %>%
  filter(condition == "gaze")

subs <- unique(g.exp$subid)
trials <- unique(g.exp$shortname)
total.looks <- 0
counted.trials <- 0
for (trial in trials){
  trialtotal <- 0
  counted.subs <- 0
  for (sub in subs){
    temp <- subset(g.exp, shortname == trial & subid == sub)
    left.to.total <- temp[[which(temp$target_object == "left" &
                                  temp$participant_looking_char == "left"), "Freq"]] +
      temp[[which(temp$target_object == "left" & temp$participant_looking_char == "right"), "Freq"]]
    right.to.total <- temp[[which(temp$target_object == "right" &
                                   temp$participant_looking_char == "left"), "Freq"]] +
      temp[[which(temp$target_object == "right" & temp$participant_looking_char == "right"), "Freq"]]
    if(left.to.total + right.to.total != 0){
      if(left.to.total == 0){
        correct_TO = "right"
        incorrect_TO = "left"
      } else{
        correct_TO = "left"
        incorrect_TO = "right"
      }
      temp <- subset(temp, target_object == correct_TO)
      corr <- temp[[which(temp$participant_looking_char == correct_TO), "Freq"]]
      incorr <- temp[[which(temp$participant_looking_char == incorrect_TO), "Freq"]]
      target <- corr / (corr+incorr)
      all.exp$exptarget[all.exp$subid == sub & all.exp$shortname == trial & 
                    all.exp$target_object == correct_TO] <- target
      total.looks <- total.looks + target
      counted.trials = counted.trials + 1
      counted.subs = counted.subs + 1
      trialtotal <- trialtotal + target
    }
  }
  trialmean <- trialtotal / counted.subs
  exp.looks.to.target$targetprop[exp.looks.to.target$shortname == trial &
                                   exp.looks.to.target$condition == "gaze"] <-trialmean
}

#proportion of looks to left object across Gaze exposure trials
socmean <- total.looks / counted.trials

all.exp <- all.exp %>%
  filter(!is.na(exptarget))
```

```{r remove temporary things, echo=FALSE}
rm(corr)
rm(correct_TO)
rm(incorr)
rm(incorrect_TO)
rm(subs)
rm(trials)
rm(temp)
rm(counted.subs)
rm(counted.trials)
rm(left.to.total)
rm(right.to.total)
rm(sub)
rm(target)
rm(total.looks)
rm(trial)
rm(trialmean)
rm(trialtotal)
```

## Munging to get Test Trial Performance

For each pair of trials, success rate is proportion of looking to target object
in test trial


```{r test looking rates ng}
all.test <- d %>% 
  filter(trial.type == "test" & participant_looking_char != "face") %>%
  xtabs(~participant_looking_char + shortname + subid + target_object, .) %>% 
  as.data.frame() %>%
  filter(participant_looking_char != "face")

# add condition variable
all.test <- d %>% 
  filter(trial.type == "test" & participant_looking_char != "face") %>%
  select(subid, condition) %>%
  unique() %>%
  left_join(all.test, by = "subid")
```

```{r}
#create table for looks to target by trial name (exposure only)
test.looks.to.target <- all.test%>%
  select(shortname, condition) %>%
  unique()

#nogaze: proportion of looking to the left over both objects for each trial
ng.test <- all.test %>%
  filter(condition == "nogaze")



subs <- unique(ng.test$subid)
trials <- unique(ng.test$shortname)
nttotal <- 0
counted.trials <- 0
for (trial in trials){
  trialtotal <- 0
  counted.subs <- 0
  for (sub in subs){
    temp <- subset(ng.test, shortname == trial & subid == sub)
    left.to.total <- temp[[which(temp$target_object == "left" &
                                   temp$participant_looking_char == "left"), "Freq"]] +
      temp[[which(temp$target_object == "left" & temp$participant_looking_char == "right"), "Freq"]]
    right.to.total <- temp[[which(temp$target_object == "right" &
                                    temp$participant_looking_char == "left"), "Freq"]] +
      temp[[which(temp$target_object == "right" & temp$participant_looking_char == "right"), "Freq"]]
    if(left.to.total + right.to.total != 0){
      if(left.to.total == 0){
        correct_TO = "right"
        incorrect_TO = "left"
      } else{
        correct_TO = "left"
        incorrect_TO = "right"
      }
      temp <- subset(temp, target_object == correct_TO)
      corr <- temp[[which(temp$participant_looking_char == correct_TO), "Freq"]]
      incorr <- temp[[which(temp$participant_looking_char == incorrect_TO), "Freq"]]
      target <- corr / (corr+incorr)
      all.test$testtarget[all.test$subid == sub & all.test$shortname == trial & 
                     all.test$target_object == correct_TO] <- target
      nttotal <- nttotal + target
      counted.trials = counted.trials + 1
      counted.subs = counted.subs + 1
      trialtotal <- trialtotal + target
    }
  }
  trialmean <- trialtotal / counted.subs
  test.looks.to.target$targetprop[test.looks.to.target$shortname == trial &
                                   test.looks.to.target$condition == "nogaze"] <-trialmean
}

#proportion of looks to left object across No Gaze exposure trials
ntmean <- nttotal / counted.trials #currently .60

```

```{r test looking rates g}
#gaze: proportion of looking to object of gaze for each trial

g.test <- all.test %>%
  filter(condition == "gaze")

subs <- unique(g.test$subid)
trials <- unique(g.test$shortname)
socttotal <- 0
counted.trials <- 0
for (trial in trials){
  trialtotal <- 0
  counted.subs <- 0
  for (sub in subs){
    temp <- subset(g.test, shortname == trial & subid == sub)
    left.to.total <- temp[[which(temp$target_object == "left" &
                                   temp$participant_looking_char == "left"), "Freq"]] +
      temp[[which(temp$target_object == "left" & temp$participant_looking_char == "right"), "Freq"]]
    right.to.total <- temp[[which(temp$target_object == "right" &
                                    temp$participant_looking_char == "left"), "Freq"]] +
      temp[[which(temp$target_object == "right" & temp$participant_looking_char == "right"), "Freq"]]
    if(left.to.total + right.to.total != 0){
      if(left.to.total == 0){
        correct_TO = "right"
        incorrect_TO = "left"
      } else{
        correct_TO = "left"
        incorrect_TO = "right"
      }
      temp <- subset(temp, target_object == correct_TO)
      corr <- temp[[which(temp$participant_looking_char == correct_TO), "Freq"]]
      incorr <- temp[[which(temp$participant_looking_char == incorrect_TO), "Freq"]]
      target <- corr / (corr+incorr)
      all.test$testtarget[all.test$subid == sub & all.test$shortname == trial & 
                     all.test$target_object == correct_TO] <- target
      socttotal <- socttotal + target
      counted.trials = counted.trials + 1
      counted.subs = counted.subs + 1
      trialtotal <- trialtotal + target
    }
  }
  trialmean <- trialtotal / counted.subs
  test.looks.to.target$targetprop[test.looks.to.target$shortname == trial &
                                   test.looks.to.target$condition == "gaze"] <-trialmean
}

#proportion of looks to left object across Gaze exposure trials
soctmean <- socttotal / counted.trials

all.test <- all.test %>%
  filter(!is.na(testtarget))
```

```{r remove temp things, echo=FALSE}
rm(corr)
rm(correct_TO)
rm(incorr)
rm(incorrect_TO)
rm(subs)
rm(trials)
rm(temp)
rm(counted.subs)
rm(counted.trials)
rm(left.to.total)
rm(right.to.total)
rm(sub)
rm(target)
rm(total.looks)
rm(trial)
rm(trialmean)
rm(trialtotal)
```

## Visualization and Analysis 

```{r analysis}
all.looks <- all.exp %>%
  left_join(all.test, by = c("subid", "condition", "participant_looking_char", "shortname")) %>%
  select(subid, condition, shortname, exptarget, testtarget) %>%
  unique()

##x-axis: how an individual did on exposure trial
##y-axis: how the individual did on test trial
qplot(x=exptarget, y=testtarget, color = condition, 
      data=all.looks) +
  facet_grid( . ~ condition) + 
  geom_smooth(method="loess", span = 1) +
  theme_bw()
```

```{r}
ms.looks <- all.looks %>%
  mutate(exptarget.bin = cut(exptarget, 4)) %>%
  group_by(exptarget.bin, condition) %>%
  multi_boot_standard(column = "testtarget", na.rm = TRUE)

qplot(exptarget.bin, mean, ymin = ci_lower, ymax = ci_upper, 
      group = condition, col = condition, geom = c("line","pointrange"),
      position = position_dodge(width = .05),
      data= ms.looks) +
  geom_hline(yintercept = .5, lty = 2) + 
  theme_bw() +
  scale_colour_solarized() + 
  ylim(c(0,1))
  
```

## Model 

Question: For each condition, does the amount of time looking at the object during exposure trials predict
the participants' success (higher accuracy) on test trials? 

Define Same and Switch trials are inferred based on participant looking during exposure trials. 

* Same trials are 
* Switch trials are...


Predictions: 

* In the gaze condition, participants will allocate more attention to the target of gaze, and thus perform at chance on 
"Switch" test trials where the target of gaze is not present. 
* In the no-gaze condition, participants will allocate equal attention to both objects on exposure trials, and thus perform better on 
"Switch" test trials.
* A quantiative relation between the amount of looking during exposure and the success at test. [allocation of attention model]
* When gaze and no-gaze participants allocate the same amount of attention during exposure, gaze participants will still perform 
worse that no gaze participants on "Switch" Trials. [social is special model]

Models:

1) Predicting looking behavior (proportion correct or proportion looking to the kept object) based on condition 
2) Predicting looking behavior based on trial type (Same/Switch binned based on looking behavior during exposure trials)

```{r}


```

